<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Кабинет оператора — БЕСКОНЕЧНЫЙ СПИСОК</title>
  <style>
    body {
      background: #fffde7;
      font-family: sans-serif;
      padding: 20px;
      margin: 0;
    }
    .card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    h2 { margin: 0 0 10px 0; color: #1b5e20; }
    .progress {
      height: 16px;
      background: #f5f5f5;
      border-radius: 8px;
      overflow: hidden;
      margin: 12px 0;
    }
    .bar {
      height: 100%;
      background: #ffeb3b;
      width: 0%;
      transition: width 0.4s;
    }
    .order {
      padding: 14px;
      margin: 10px 0;
      background: #fafafa;
      border-radius: 6px;
      line-height: 1.5;
    }
    .order-header {
      display: flex;
      justify-content: space-between;
      font-weight: bold;
      margin-bottom: 6px;
    }
    .btn {
      background: #ffeb3b;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      margin: 0 4px;
    }
    .btn-gray {
      background: #e0e0e0;
    }
    .form-row {
      margin: 8px 0;
    }
    input, select {
      padding: 6px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 100%;
    }
    #orders {
      min-height: 40px;
    }
  </style>
</head>
<body>
  <div class="card">
    <h2>Оператор №1</h2>
    <p>Всего: <span id="total">0 ₽</span></p>
    <p>Сегодня: <span id="today">0 ₽</span> / 3000 ₽</p>
    <div class="progress"><div class="bar" id="bar"></div></div>
    <button class="btn" onclick="reset()">Начать смену</button>
  </div>

  <div class="card">
    <h3>Создать заказ</h3>
    <input id="num" placeholder="№ заказа" style="width:100%; margin:6px 0;">
    <button class="btn" onclick="addRow()">+ Деталь</button>
    <div id="rows"></div>
    <button class="btn" onclick="create()">Создать</button>
  </div>

  <div class="card">
    <h3>Все заказы</h3>
    <div id="orders">Нет заказов</div>
    <button class="btn" onclick="exportAll()">Скачать TXT</button>
  </div>

  <script>
    // === Состояние ===
    let state = JSON.parse(localStorage.getItem('op')) || {
      total: 0,
      today: 0,
      list: []
    };

    function save() {
      localStorage.setItem('op', JSON.stringify(state));
      document.getElementById('total').textContent = fmt(state.total);
      document.getElementById('today').textContent = fmt(state.today);
      const perc = Math.min(100, (state.today / 3000) * 100);
      document.getElementById('bar').style.width = perc + '%';
      render();
    }

    function fmt(n) {
      return new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB' }).format(n);
    }

    // === Рендеринг — БЕСКОНЕЧНЫЙ СПИСОК ===
    function render() {
      const el = document.getElementById('orders');
      if (state.list.length === 0) {
        el.innerHTML = 'Нет заказов';
        return;
      }

      el.innerHTML = state.list.map((o, i) => `
        <div class="order">
          <div class="order-header">
            <span>№${o.num}</span>
            <span>${fmt(o.total)}</span>
          </div>
          ${o.items.map(it => 
            `<div>${it.d} • ${it.s} ×${it.q} = ${fmt(it.p)}</div>`
          ).join('')}
          <button class="btn-gray" onclick="del(${i})">Удалить</button>
        </div>
      `).join('');
    }

    // === Добавление детали ===
    function addRow() {
      document.getElementById('rows').innerHTML += `
        <div class="form-row">
          <input placeholder="деталь" data-d style="width:120px; margin-right:6px;">
          <select data-s style="margin-right:6px; width:150px;">
            <option value="Распил">Распил (65₽/м²)</option>
            <option value="Линейный">Линейный (26₽/п.м.)</option>
            <option value="Склейка+">Склейка+ (210₽/м²)</option>
            <option value="Склейка-">Склейка- (165₽/м²)</option>
            <option value="Пазы">Пазы (30₽/п.м.)</option>
            <option value="Фаска">Фаска (16₽/п.м.)</option>
            <option value="Время">Время (330₽/ч)</option>
          </select>
          <input type="number" value="1" data-q min="1" style="width:60px; margin-right:6px;">
          <input type="number" step="0.01" data-l placeholder="длина" style="width:80px; margin-right:6px;">
          <input type="number" step="0.01" data-w placeholder="ширина" style="width:80px;">
          <button class="btn-gray" onclick="this.parentNode.remove()">✕</button>
        </div>
      `;
    }

    // === Создание заказа ===
    function create() {
      const num = document.getElementById('num').value.trim();
      if (!num) return alert('Введите номер заказа!');

      const rows = document.querySelectorAll('#rows > .form-row');
      if (rows.length === 0) return alert('Добавьте деталь');

      let total = 0;
      const items = [];

      rows.forEach(row => {
        const d = row.querySelector('[data-d]')?.value || '—';
        const s = row.querySelector('[data-s]')?.value || '—';
        const q = +row.querySelector('[data-q]')?.value || 1;
        const l = +row.querySelector('[data-l]')?.value || 0;
        const w = +row.querySelector('[data-w]')?.value || 0;

        let p = 0;
        if (s === 'Время') p = 330 * l * q;
        else if (s.includes('м²') || s === 'Распил' || s === 'Склейка+') {
          p = (s === 'Распил' ? 65 : s === 'Склейка+' ? 210 : 165) * l * w * q;
        } else {
          p = (s === 'Линейный' ? 26 : s === 'Пазы' ? 30 : 16) * l * q;
        }

        items.push({ d, s, q, p });
        total += p;
      });

      state.list.push({ num, items, total });
      state.total += total;
      state.today += total;
      save();

      document.getElementById('num').value = '';
      document.getElementById('rows').innerHTML = '';
    }

    // === Удаление ===
    function del(i) {
      const o = state.list.splice(i, 1)[0];
      state.total -= o.total;
      state.today -= o.total;
      save();
    }

    // === Сброс ===
    function reset() {
      if (confirm('Сбросить смену?')) {
        state.today = 0;
        save();
      }
    }

    // === Экспорт ===
    function exportAll() {
      let txt = 'ВСЕ ЗАКАЗЫ\n============\n';
      state.list.forEach((o, i) => {
        txt += `\n№${o.num} — ${fmt(o.total)}\n`;
        o.items.forEach(it => txt += `- ${it.d} | ${it.s} ×${it.q} = ${fmt(it.p)}\n`);
      });
      txt += `\nИТОГО: ${fmt(state.total)}`;

      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([txt], { type: 'text/plain' }));
      a.download = 'все_заказы.txt';
      a.click();
    }

    // Инициализация
    save();
  </script>
</body>
</html>
