<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Оператор — 100% работает</title>
  <style>
    body { background:#fffde7; font-family:sans-serif; padding:20px; }
    .box { background:#fff; border-radius:8px; padding:20px; margin:16px 0; box-shadow:0 2px 6px #eee; }
    h2 { color:#1b5e20; margin:0 0 12px 0; }
    .progress { height:16px; background:#f5f5f5; border-radius:8px; overflow:hidden; }
    .fill { height:100%; background:#ffeb3b; width:0%; transition:width 0.4s; }
    .item { margin:10px 0; padding:12px; background:#fafafa; border-radius:4px; }
    button { background:#ffeb3b; border:none; padding:6px 12px; border-radius:4px; margin:4px; cursor:pointer; }
    button.gray { background:#e0e0e0; }
    #orders { min-height: 40px; }
  </style>
</head>
<body>
  <div class="box">
    <h2>Оператор №1</h2>
    <p>Всего: <span id="total">0 ₽</span></p>
    <p>Сегодня: <span id="today">0 ₽</span> / 3000 ₽</p>
    <div class="progress"><div class="fill" id="fill"></div></div>
    <button onclick="reset()">Начать смену</button>
  </div>

  <div class="box">
    <h3>Создать заказ</h3>
    <input id="num" placeholder="№ заказа" style="width:100%; padding:6px; margin:6px 0;">
    <button onclick="addRow()">+ Деталь</button>
    <div id="rows"></div>
    <button onclick="create()">Создать</button>
  </div>

  <div class="box">
    <h3>Заказы за сегодня</h3>
    <div id="orders">Нет заказов</div>
    <button onclick="exportTxt()">Скачать TXT</button>
  </div>

  <script>
    let state = JSON.parse(localStorage.getItem('op')) || { total: 0, today: 0, list: [] };

    function save() {
      localStorage.setItem('op', JSON.stringify(state));
      document.getElementById('total').textContent = fmt(state.total);
      document.getElementById('today').textContent = fmt(state.today);
      const perc = Math.min(100, (state.today / 3000) * 100);
      document.getElementById('fill').style.width = perc + '%';
      render();
    }

    function fmt(n) {
      return new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB' }).format(n);
    }

    function render() {
      const el = document.getElementById('orders');
      if (state.list.length === 0) {
        el.innerHTML = 'Нет заказов';
        return;
      }
      el.innerHTML = state.list.map((o, i) => `
        <div class="item">
          №${o.num} — ${fmt(o.total)}
          <div>${o.items.map(it => `${it.d} • ${it.s} ×${it.q} = ${fmt(it.p)}`).join('<br>')}</div>
          <button class="gray" onclick="del(${i})">Удалить</button>
        </div>
      `).join('');
    }

    function addRow() {
      document.getElementById('rows').innerHTML += `
        <div style="margin:8px 0; padding:8px; background:#f9f9f9; border-radius:4px;">
          <input placeholder="деталь" data-d style="width:100px;margin-right:6px;">
          <select data-s style="margin-right:6px;">
            <option value="Распил">Распил (65)</option>
            <option value="Линейный">Линейный (26)</option>
            <option value="Склейка+">Склейка+ (210)</option>
            <option value="Склейка-">Склейка- (165)</option>
            <option value="Пазы">Пазы (30)</option>
            <option value="Фаска">Фаска (16)</option>
            <option value="Время">Время (330)</option>
          </select>
          <input type="number" value="1" data-q min="1" style="width:50px;margin-right:6px;">
          <input type="number" step="0.01" data-l placeholder="длина" style="width:70px;">
          <input type="number" step="0.01" data-w placeholder="ширина" style="width:70px;">
          <button class="gray" onclick="this.parentNode.remove()">✕</button>
        </div>
      `;
    }

    function create() {
      const num = document.getElementById('num').value.trim();
      if (!num) return alert('Введите номер заказа!');

      const rows = document.querySelectorAll('#rows > div');
      if (rows.length === 0) return alert('Добавьте деталь');

      let total = 0;
      const items = [];

      rows.forEach(row => {
        const d = row.querySelector('[data-d]')?.value || '—';
        const s = row.querySelector('[data-s]')?.value || '—';
        const q = +row.querySelector('[data-q]')?.value || 1;
        const l = +row.querySelector('[data-l]')?.value || 0;
        const w = +row.querySelector('[data-w]')?.value || 0;

        let p = 0;
        if (s === 'Время') p = 330 * l * q;
        else if (s.includes('м²') || s === 'Распил' || s === 'Склейка+') p = (s === 'Распил' ? 65 : s === 'Склейка+' ? 210 : 165) * l * w * q;
        else p = (s === 'Линейный' ? 26 : s === 'Пазы' ? 30 : 16) * l * q;

        items.push({ d, s, q, p });
        total += p;
      });

      state.list.push({ num, items, total });
      state.total += total;
      state.today += total;
      save();

      document.getElementById('num').value = '';
      document.getElementById('rows').innerHTML = '';
    }

    function del(i) {
      const o = state.list.splice(i, 1)[0];
      state.total -= o.total;
      state.today -= o.total;
      save();
    }

    function reset() {
      if (confirm('Сбросить смену?')) {
        state.today = 0;
        save();
      }
    }

    function exportTxt() {
      let txt = 'ЗАКАЗЫ ЗА СЕГОДНЯ\n====================\n';
      state.list.forEach(o => {
        txt += `\n№${o.num} — ${fmt(o.total)}\n`;
        o.items.forEach(it => txt += `- ${it.d} | ${it.s} ×${it.q} = ${fmt(it.p)}\n`);
      });
      txt += `\nИТОГО: ${fmt(state.today)}`;

      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([txt], {type:'text/plain'}));
      a.download = 'заказы.txt';
      a.click();
    }

    save();
  </script>
</body>
</html>
